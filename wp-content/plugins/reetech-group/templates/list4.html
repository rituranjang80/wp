<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generic Data Table</title>
    
    <!-- Required CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">

    <style>
        .badge { font-size: 0.9em; }
        .data-table-wrapper { padding: 20px; }
        a { text-decoration: none; }
        .dropdown-menu { min-width: 8rem; }
        .filter-row { background: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        .bootstrap-select .btn { height: calc(2.25rem + 2px); }
    </style>
</head>
<body>
    <div class="container" id="data-table-container">
        <!-- Filter Section will be auto-generated -->
        <table id="main-data-table" class="table table-striped" style="width:100%"></table>
    </div>

    <!-- Required JavaScript -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>

    <script>

var Customeroptions = [
    { value: 0, label: 'All Customers' },
    { value: 1, label: 'Customer 1' },
    { value: 2, label: 'Customer 2' },
    { value: 3, label: 'Customer 3' },
    { value: 4, label: 'Customer 4' },
    { value: 5, label: 'Customer 5' },
    { value: 6, label: 'Customer 6' },
    { value: 7, label: 'Customer 7' },
    { value: 8, label: 'Customer 8' },
    { value: 9, label: 'Customer 9' },
    { value: 10, label: 'Customer 10' },
    { value: 11, label: 'Customer 11' },
    { value: 12, label: 'Customer 12' },
    { value: 13, label: 'Customer 13' },
    { value: 14, label: 'Customer 14' },
    { value: 15, label: 'Customer 15' },
    { value: 16, label: 'Customer 16' },
    { value: 17, label: 'Customer 17' },
    { value: 18, label: 'Customer 18' },
    { value: 19, label: 'Customer 19' },
    { value: 20, label: 'Customer 20' }
];
class GenericDataTable {
    constructor(config) {
        this.config = {
            container: '#data-table-container',
            tableId: '#main-data-table',
            ajax: {
                url: '',
                method: 'GET',
                headers: {}
            },
            filters: [],
            columns: [],
            actions: [],
            translations: {
                emptyTable: "No data found",
                processing: "<i class='fa fa-spinner fa-spin'></i> Loading..."
            },
            ...config
        };
        
        this.init();
    }

    init() {
        this.createFilterSection();
        this.initDataTable();
        this.bindEvents();
    }

    createFilterSection() {
        const filterHtml = `
            <div class="filter-row">
                <div class="row row-cols-1 row-cols-lg-3 g-2 align-items-end">
                    ${this.config.filters.map(filter => this.createFilterControl(filter)).join('')}
                    <div class="col">
                        <button class="btn btn-primary w-100 reset-filters">
                            <i class="fas fa-sync"></i> Reset
                        </button>
                    </div>
                </div>
            </div>`;
        
        $(this.config.container).prepend(filterHtml);
        this.initSelectPickers();
    }

    createFilterControl(filter) {
        switch(filter.type) {
            case 'multiselect':
                return `
                    <div class="col">
                        <label class="form-label">${filter.label}</label>
                        <select class="selectpicker form-control ${filter.class || ''}" 
                                id="${filter.id}" multiple 
                                data-live-search="true" 
                                title="${filter.placeholder || 'Select...'}">
                            ${filter.options ? filter.options.map(opt => 
                                `<option value="${opt.value}">${opt.label}</option>`).join('') : ''}
                        </select>
                    </div>`;
                
            case 'date':
                return `
                    <div class="col">
                        <label class="form-label">${filter.label}</label>
                        <input type="date" class="form-control ${filter.class || ''}" 
                               id="${filter.id}" ${filter.range ? 'data-range' : ''}>
                    </div>`;
                
            default:
                return '';
        }
    }

    initSelectPickers() {
        $('.selectpicker').selectpicker();
    }

    initDataTable() {
        this.dataTable = $(this.config.tableId).DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: this.config.ajax.url,
                type: this.config.ajax.method,
                headers: this.config.ajax.headers,
                data: (d) => this.getRequestData(d)
            },
            columns: this.getColumnsConfig(),
            language: this.config.translations,
            createdRow: (row, data) => this.handleRowCreation(row, data)
        });
    }

    getRequestData(d) {
        const filterData = {};
        this.config.filters.forEach(filter => {
            filterData[filter.id] = $(`#${filter.id}`).val();
        });

        return {
            draw: d.draw,
            start: d.start,
            length: d.length,
            search: d.search.value,
            orderby: d.columns[d.order[0].column].data,
            order: d.order[0].dir,
            ...filterData
        };
    }

    getColumnsConfig() {
        return this.config.columns.map(col => ({
            data: col.data,
            title: col.title,
            className: col.className || '',
            orderable: col.orderable !== false,
            render: (data, type, row) => this.renderColumn(col, data, type, row)
        }));
    }

    // renderColumn(col, data, type, row) {
    //     if (col.render) return col.render(data, type, row);
    //     if (col.type === 'link') return `<a href="${col.href(row)}" class="${col.class}">${data}</a>`;
    //     if (col.type === 'badge') return `<span class="badge bg-${col.color(data)}">${data}</span>`;
    //     if (col.type === 'actions') return this.renderActions(row);
    //     return data;
    // }

    renderColumn(col, data, type, row) {
    // Check if render is a function first
    if (typeof col.render === 'function') {
        return col.render(data, type, row);
    }
    // Then check type-based renders
    if (col.type === 'link') {
        return `<a href="${col.href(row)}" class="${col.class || ''}">${data}</a>`;
    }
    if (col.type === 'badge') {
        const color = typeof col.color === 'function' ? col.color(data) : col.color;
        return `<span class="badge bg-${color}">${data}</span>`;
    }
    if (col.type === 'actions') {
        return this.renderActions(row);
    }
    // Fallback to default data rendering
    return data;
}

    renderActions(row) {
        return `
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                        type="button" data-bs-toggle="dropdown">
                    Actions
                </button>
                <ul class="dropdown-menu">
                    ${this.config.actions.map(action => `
                        <li>
                            <a class="dropdown-item" href="${action.url(row)}">
                                ${action.icon ? `<i class="${action.icon}"></i>` : ''}
                                ${action.label}
                            </a>
                        </li>
                    `).join('')}
                </ul>
            </div>`;
    }

    bindEvents() {
        // Filter changes
        this.config.filters.forEach(filter => {
            $(`#${filter.id}`).on('change', () => this.dataTable.ajax.reload());
        });

        // Reset filters
        $('.reset-filters').click(() => this.resetFilters());

        // Prevent dropdown close
        $(this.config.tableId).on('click', '.dropdown-menu a', (e) => e.stopPropagation());
    }

    resetFilters() {
        this.config.filters.forEach(filter => {
            const el = $(`#${filter.id}`);
            if (filter.type === 'multiselect') {
                el.val([]).selectpicker('refresh');
            } else {
                el.val('');
            }
        });
        this.dataTable.ajax.reload();
    }

    handleRowCreation(row, data) {
        if (this.config.onRowCreated) {
            this.config.onRowCreated(row, data);
        }
    }
}



// Example initialization
const invoicesTable = new GenericDataTable({

   
    ajax: {
        url: 'http://localhost/wordpress1/wp-json/reetech-group/v1/invoices-summary'
    },
    filters: [
        {
            id: 'customerFilter',
            type: 'multiselect',
            label: 'Customers',
            options: Customeroptions, // Can be populated dynamically
            source: 'http://localhost/wordpress1/wp-json/reetech-group/v1/customers'
        },
        {
            id: 'fromDate',
            type: 'date',
            label: 'From Date'
        },
        {
            id: 'toDate',
            type: 'date',
            label: 'To Date'
        }
    ],
    columns: [
        { 
            data: 'invoice_number',
            title: 'Invoice #',
            type: 'link',
            href: (row) => `invoice.html?id=${row.invoice_number}`
        },
        { 
            data: 'customer',
            title: 'Customer',
            type: 'link',
            href: (row) => `customer.html?id=${row.customer_id}`
        },
        { 
            data: 'date', 
            title: 'Date',
            render: (data) => data && data !== '0000-00-00' ? 
                new Date(data).toLocaleDateString() : 'N/A'
        },
        { 
            data: 'total', 
            title: 'Total',
            render: $.fn.dataTable.render.number(',', '.', 2, '$')
        },
        { 
            data: 'balance', 
            title: 'Balance',
            render: (data, type) => {
                if (type === 'display') {
                    const numericValue = parseFloat(data);
                    const color = numericValue > 0 ? 'danger' : 'success';
                    return `<span class="badge bg-${color}">$${Math.abs(numericValue).toFixed(2)}</span>`;
                }
                return data;
            }
        },
        { 
            data: 'status', 
            title: 'Status',
            render: (data) => {
                const statusMap = { paid: 'success', pending: 'warning', overdue: 'danger' };
                return `<span class="badge bg-${statusMap[data] || 'secondary'}">${data}</span>`;
            }
        },
        { 
            data: null,
            title: 'Actions',
            type: 'actions',
            orderable: false
        }
    ],
    actions: [
        {
            label: 'Edit',
            url: (row) => `edit.html?id=${row.invoice_number}`,
            icon: 'fas fa-edit'
        },
        {
            label: 'View',
            url: (row) => `view.html?id=${row.invoice_number}`,
            icon: 'fas fa-eye'
        }
    ]
});
</script>
</body>
</html>